name: Databricks Apps ç›‘æ§

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯ 10 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '*/10 * * * *'

  # æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒé€‰æ‹©æ“ä½œç±»å‹
  workflow_dispatch:
    inputs:
      action:
        description: 'æ“ä½œç±»å‹'
        required: true
        default: 'check'
        type: choice
        options:
          - check        # æ™ºèƒ½æ£€æŸ¥ï¼ˆARGOä¼˜å…ˆï¼‰
          - status       # ä»…è·å– Apps çŠ¶æ€
          - start        # å¯åŠ¨æ‰€æœ‰åœæ­¢çš„ Apps
          - test-notify  # æµ‹è¯• Telegram é€šçŸ¥

env:
  NODE_VERSION: '20'

jobs:
  monitor:
    runs-on: ubuntu-latest
    name: Databricks Apps ç›‘æ§ä»»åŠ¡

    steps:
      - name: ç­¾å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æ¢å¤ ARGO çŠ¶æ€ç¼“å­˜
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: .argo-status.json
          key: argo-status-
          restore-keys: |
            argo-status-

      - name: æ‰§è¡Œç›‘æ§è„šæœ¬
        id: monitor
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          ARGO_DOMAIN: ${{ secrets.ARGO_DOMAIN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          # å®šæ—¶ä»»åŠ¡é»˜è®¤ checkï¼Œæ‰‹åŠ¨è§¦å‘ä½¿ç”¨é€‰æ‹©çš„æ“ä½œ
          ACTION: ${{ github.event_name == 'schedule' && 'check' || github.event.inputs.action || 'check' }}
        run: node monitor.js

      - name: ä¿å­˜ ARGO çŠ¶æ€ç¼“å­˜
        if: always()
        uses: actions/cache/save@v4
        with:
          path: .argo-status.json
          key: argo-status-${{ github.run_id }}

      # ====== Telegram é€šçŸ¥ï¼šå·¥ä½œæµæ‰§è¡Œç»“æœ ======
      - name: å‘é€ Telegram æˆåŠŸé€šçŸ¥
        if: success() && secrets.CHAT_ID != '' && secrets.BOT_TOKEN != ''
        env:
          CHAT_ID: ${{ secrets.CHAT_ID }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ACTION: ${{ github.event_name == 'schedule' && 'check' || github.event.inputs.action || 'check' }}
        run: |
          TEXT="âœ… <b>GitHub Actions æ‰§è¡ŒæˆåŠŸ</b>%0A%0A"
          TEXT+="ğŸ“‹ æ“ä½œ: <code>${ACTION}</code>%0A"
          TEXT+="ğŸ”„ è§¦å‘æ–¹å¼: <code>${{ github.event_name }}</code>%0A"
          TEXT+="ğŸ·ï¸ è¿è¡Œç¼–å·: <code>#${{ github.run_number }}</code>%0A"
          TEXT+="â° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')%0A%0A"
          TEXT+="ğŸ”— <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>æŸ¥çœ‹æ—¥å¿—</a>"

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${CHAT_ID}\",\"text\":\"${TEXT}\",\"parse_mode\":\"HTML\",\"disable_web_page_preview\":true}"

      - name: å‘é€ Telegram å¤±è´¥é€šçŸ¥
        if: failure() && secrets.CHAT_ID != '' && secrets.BOT_TOKEN != ''
        env:
          CHAT_ID: ${{ secrets.CHAT_ID }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ACTION: ${{ github.event_name == 'schedule' && 'check' || github.event.inputs.action || 'check' }}
        run: |
          TEXT="âŒ <b>GitHub Actions æ‰§è¡Œå¤±è´¥</b>%0A%0A"
          TEXT+="ğŸ“‹ æ“ä½œ: <code>${ACTION}</code>%0A"
          TEXT+="ğŸ”„ è§¦å‘æ–¹å¼: <code>${{ github.event_name }}</code>%0A"
          TEXT+="ğŸ·ï¸ è¿è¡Œç¼–å·: <code>#${{ github.run_number }}</code>%0A"
          TEXT+="â° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')%0A%0A"
          TEXT+="âš ï¸ è¯·æ£€æŸ¥æ—¥å¿—æ’æŸ¥é—®é¢˜%0A"
          TEXT+="ğŸ”— <a href='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'>æŸ¥çœ‹æ—¥å¿—</a>"

          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\":\"${CHAT_ID}\",\"text\":\"${TEXT}\",\"parse_mode\":\"HTML\",\"disable_web_page_preview\":true}"
